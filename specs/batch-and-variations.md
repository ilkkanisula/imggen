# Nanobanana Batch & Variations Spec

## Overview
Batch processing and variation generation using natural language parsing with Gemini API.

## Workflow

Two-step process: parse natural language to YAML, review, then generate images.

### Step 1: Parse (Natural Language → YAML)
```bash
uv run generate.py --parse prompts.txt --output batch.yaml
```
Converts user text to structured YAML via Gemini. User reviews before generation.

### Step 2: Generate (YAML → Images)
```bash
uv run generate.py batch.yaml
```
Generates images from YAML. Fully reproducible—YAML is the source of truth.

## Input Format

### Natural Language File (prompts.txt)
```
Create 4 versions of a mountain landscape at sunset

I need 6 variations of a futuristic city

Generate 2 versions of a winter cabin
```

### Parsed YAML File (batch.yaml)
Generated by parse phase, editable by user:
```yaml
images:
  - prompt: "serene mountain landscape at sunset"
    variations: 4
  - prompt: "futuristic city scene"
    variations: 4  # capped from 6
  - prompt: "cozy winter cabin"
    variations: 2

global_style_references: []
```

## Parsing (Gemini Structured Output)

Parse phase uses Gemini's structured output feature to guarantee valid JSON response.

Configure Gemini with:
- `response_mime_type`: "application/json"
- `response_json_schema`: schema matching batch.yaml structure

Parsing rules:
- Default 4 variations per image
- Map user terms: "widescreen" → "16:9", "portrait" → "9:16"
- Extract file paths for style references
- Cap variations at 4 maximum
- Clean and normalize prompts

## Safety Limits
- Max 4 variations per image (enforce in parsing, warn if capped)
- Show total image count before generation begins

## Output Structure

```
output/
├── image_001/
│   ├── image.png
│   └── prompt.txt
├── image_002/
│   ├── image.png
│   └── prompt.txt
├── image_003/
│   ├── image.png
│   └── prompt.txt
└── batch_manifest.json
```

**Manifest format:**
```json
{
  "timestamp": "2024-01-08T15:30:00Z",
  "images": [
    {
      "id": "image_001",
      "prompt": "A mountain at sunset",
      "status": "success|failed",
      "output": "image.png",
      "file": "image_001/image.png"
    }
  ]
}
```

## File Storage Details
- Each image: `image_NNN/image.png` and `image_NNN/prompt.txt`
- Manifest: `batch_manifest.json`
- Benefit: exact prompt stored enables reproducible regeneration

## Implementation

Single script (generate.py) with two modes. See Core Functions below for detailed logic.

### Core Functions

**parse_mode(input_file, output_file):**
- Read natural language file, send to Gemini with structured output config
- Convert JSON response to YAML, enforce 4 variation cap
- Display summary and save YAML file

**generate_mode(yaml_file):**
- Read and validate YAML
- For each image: generate variations, save to image_NNN/ directory
- Save manifest with completion status

**generate_image(prompt, output_dir):**
- Call Gemini image API, save image and prompt.txt
- Handle errors gracefully

## Error Handling

- **Rate limit (429):** Save manifest and exit (user can resume)
- **Parse errors:** Show error, ask for clarification
- **Missing files:** Clear error and exit

## Example Workflow

**1. User creates prompts.txt:**
```
Create 4 versions of a serene mountain landscape at sunset

I need 6 variations of a futuristic city scene

Generate 2 versions of a cozy winter cabin
```

**2. User parses:**
```bash
uv run generate.py --parse prompts.txt --output batch.yaml
```

Output:
```
Parsed successfully!
Will generate 10 images from 3 prompts:
  • "serene mountain landscape at sunset" (4 variations)
  • "futuristic city scene" (4 variations, capped from 6)
  • "cozy winter cabin" (2 variations)

Saved to: batch.yaml
Ready to generate! Run: uv run generate.py batch.yaml
```

**3. User reviews batch.yaml:**
```yaml
images:
  - prompt: "serene mountain landscape at sunset"
    variations: 4
  - prompt: "futuristic city scene"
    variations: 4
  - prompt: "cozy winter cabin"
    variations: 2

global_style_references: []
```

User can edit if parsing wasn't perfect.

**4. User generates:**
```bash
uv run generate.py batch.yaml
```

Output structure:
```
output/
├── image_001/
│   ├── image.png
│   └── prompt.txt  # "serene mountain landscape at sunset"
├── image_002/
│   ├── image.png
│   └── prompt.txt
...
├── image_010/
│   ├── image.png
│   └── prompt.txt
└── batch_manifest.json
```

**5. Future reproduction:**
```bash
# Can regenerate image_005 with exact same prompt:
cat output/image_005/prompt.txt
# Output: "futuristic city scene"

# Edit batch.yaml to regenerate only that one,
# or use it as reference for new batch
```

## Design Principles (KISS)

**Keep:**
- Single script (generate.py) with two modes
- Two-step workflow: parse → review → generate
- YAML as source of truth (editable, transparent)
- Reproducible via stored prompts
- Max 4 variations per image

**Don't add:**
- Interactive mode, parallel processing, web UI
- Resume logic (restart is simple)
- Config beyond YAML, extra parameters

## Critical Implementation Files

- `/Users/ilkkanisula/work/ai/tools/nanobanana/generate.py` - Rewrite as single script
- `/Users/ilkkanisula/work/ai/tools/nanobanana/README.md` - Update docs
- `/Users/ilkkanisula/work/ai/tools/nanobanana/specs/batch-and-variations.md` - This file

## YAML Schema

**batch.yaml format (validated, editable):**

```yaml
# Generated by parse phase, can be edited before generation
images:
  - prompt: "image description"
    variations: 4  # 1-4, capped at 4
    aspect_ratio: "16:9"  # optional: "1:1", "16:9", "9:16", "4:3", "3:4"
    resolution: "2K"  # optional: "1K", "2K", "4K"

global_style_references: []  # optional: list of image paths
```

**Validation rules:**
- `prompt` required, non-empty string
- `variations` optional, default 4, max 4
- `aspect_ratio` optional, from whitelist
- `resolution` optional, from whitelist
- `global_style_references` optional, list of existing files

## Implementation Notes

- Use `gemini-2.5-flash` for parsing (cost-effective)
- Use `gemini-3-pro-image-preview` for image generation (quality)
- Parse: one Gemini call with structured output config per batch
- Generate: one call per variation
- YAML validates schema before generation
- Parsing phase only parses—no image generation
